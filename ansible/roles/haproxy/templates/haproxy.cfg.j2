# HAProxy Configuration for PostgreSQL HA Cluster
# Generated by Ansible - DO NOT EDIT MANUALLY

#------------------------------------------------------------------------------
# GLOBAL SETTINGS
#------------------------------------------------------------------------------

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn {{ haproxy_maxconn_global }}

    # SSL settings (for future use)
    # ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM
    # ssl-default-bind-options ssl-min-ver TLSv1.2

#------------------------------------------------------------------------------
# DEFAULT SETTINGS
#------------------------------------------------------------------------------

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    option  redispatch
    retries 3
    timeout connect {{ haproxy_timeout_connect }}
    timeout client  {{ haproxy_timeout_client }}
    timeout server  {{ haproxy_timeout_server }}
    timeout check   5s
    maxconn {{ haproxy_maxconn_frontend }}

#------------------------------------------------------------------------------
# STATISTICS PAGE
#------------------------------------------------------------------------------

listen stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
    stats admin if TRUE

#------------------------------------------------------------------------------
# POSTGRESQL READ-WRITE (PRIMARY ONLY)
#------------------------------------------------------------------------------

# Frontend for read-write connections (routes to primary)
frontend pg_frontend_rw
    bind *:{{ haproxy_pg_rw_port }}
    mode tcp
    option tcplog
    default_backend pg_backend_primary

# Backend for primary (read-write)
backend pg_backend_primary
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    
    default-server inter {{ haproxy_health_check_interval }} fall {{ haproxy_health_check_fall }} rise {{ haproxy_health_check_rise }} on-marked-down shutdown-sessions maxconn {{ haproxy_maxconn_backend }}

    # Primary server
    server pg-primary {{ pg_primary_ip }}:5432 check port 8008

    # Standby servers as backup (will be used if primary fails and gets promoted)
{% for ip in pg_standby_ips %}
    server pg-standby-{{ loop.index }} {{ ip }}:5432 check port 8008 backup
{% endfor %}

#------------------------------------------------------------------------------
# POSTGRESQL READ-ONLY (ALL SERVERS, LOAD BALANCED)
#------------------------------------------------------------------------------

# Frontend for read-only connections (load balanced across all nodes)
frontend pg_frontend_ro
    bind *:{{ haproxy_pg_ro_port }}
    mode tcp
    option tcplog
    default_backend pg_backend_replicas

# Backend for read replicas (load balanced)
backend pg_backend_replicas
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200

    default-server inter {{ haproxy_health_check_interval }} fall {{ haproxy_health_check_fall }} rise {{ haproxy_health_check_rise }} maxconn {{ haproxy_maxconn_backend }}

    # All servers can handle read queries
    server pg-primary {{ pg_primary_ip }}:5432 check port 8008
{% for ip in pg_standby_ips %}
    server pg-standby-{{ loop.index }} {{ ip }}:5432 check port 8008
{% endfor %}
