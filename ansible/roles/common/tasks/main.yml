---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true

- name: Install common packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
  become: true

- name: Set timezone
  ansible.builtin.timezone:
    name: UTC
  become: true

- name: Configure /etc/hosts for cluster nodes
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item].private_ip }} {{ item }}"
    state: present
  loop: "{{ groups['all'] }}"
  when: hostvars[item].private_ip is defined
  become: true

- name: Disable swap (recommended for databases)
  ansible.builtin.command: swapoff -a
  become: true
  changed_when: false

- name: Remove swap from fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '\sswap\s'
    state: absent
  become: true

- name: Configure sysctl for PostgreSQL
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { name: 'vm.swappiness', value: '1' }
    - { name: 'vm.overcommit_memory', value: '2' }
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
  become: true
  when: "'pg_cluster' in group_names"
